<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>N-FCCLA Form</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <!-- ACTFL Form -->
    <form id="actflForm" class="card">
      <div class="form-header">
        <h2>N-FCCLA Form</h2>
        <div class="form-actions">
          <button type="button" id="downloadBtn" class="btn ghost">
            N-FCCLA (Download Excel)
          </button>
        </div>
      </div>

      <div class="datass">
        <label class="labels">SurveyYear:</label>
        <div class="static-data"><span>2026</span></div>
      </div>

      <div class="datass">
        <label class="labels">SurveyType:</label>
        <div class="static-data"><span>SP</span></div>
      </div>

      <hr />

      <div class="datas-groupss">
        <div class="datas">
          <label class="labels"
            >EVID:
            <input type="text" minlength="9" maxlength="9" name="evid" />
          </label>
        </div>
        <div class="datas">
          <label class="labels"
            >Form:
            <input type="text" minlength="5" maxlength="5" name="form" />
          </label>
        </div>
      </div>

      <label class="labels"
        >First Name:
        <input type="text" name="firstName" />
      </label>

      <label class="labels"
        >Last Name:
        <input type="text" name="lastName" />
      </label>

      <label class="labels"
        >Home Address:
        <input type="text" name="homeAddress" />
      </label>

      <label class="labels"
        >City:
        <input type="text" name="city" />
      </label>

      <label class="labels"
        >State:
        <input type="text" name="state" />
      </label>

      <label class="labels"
        >Zip Code:
        <input type="text" minlength="5" maxlength="5" name="zipCode" />
      </label>

      <label class="labels"
        >Zip4 Code:
        <input type="text" maxlength="4" name="zipCode4" />
      </label>

      <label class="labels"
        >Personal Email:
        <input type="email" name="personalEmail" />
      </label>

      <label class="birth-label labels">Birth Date:</label>
      <div class="dob">
        <div class="dob-col">
          <small><label for="birthMonth">Month</label></small>
          <select name="birthMonth" id="birthMonth">
            <option value="">MM</option>
            <option value="01">01</option><option value="02">02</option><option value="03">03</option>
            <option value="04">04</option><option value="05">05</option><option value="06">06</option>
            <option value="07">07</option><option value="08">08</option><option value="09">09</option>
            <option value="10">10</option><option value="11">11</option><option value="12">12</option>
          </select>
        </div>

        <div class="dob-col">
          <small><label for="birthDay">Day</label></small>
          <select name="birthDay" id="birthDay">
            <option value="">DD</option>
            <option value="01">01</option><option value="02">02</option><option value="03">03</option>
            <option value="04">04</option><option value="05">05</option><option value="06">06</option>
            <option value="07">07</option><option value="08">08</option><option value="09">09</option>
            <option value="10">10</option><option value="11">11</option><option value="12">12</option>
            <option value="13">13</option><option value="14">14</option><option value="15">15</option>
            <option value="16">16</option><option value="17">17</option><option value="18">18</option>
            <option value="19">19</option><option value="20">20</option><option value="21">21</option>
            <option value="22">22</option><option value="23">23</option><option value="24">24</option>
            <option value="25">25</option><option value="26">26</option><option value="27">27</option>
            <option value="28">28</option><option value="29">29</option><option value="30">30</option>
            <option value="31">31</option>
          </select>
        </div>

        <div class="dob-col">
          <small><label for="birthYear">Year</label></small>
          <select name="birthYear" id="birthYear">
            <option value="">YYYY</option>
            <option value="2006">2006</option><option value="2007">2007</option><option value="2008">2008</option>
            <option value="2009">2009</option><option value="2010">2010</option><option value="2011">2011</option>
            <option value="2012">2012</option><option value="2013">2013</option>
          </select>
        </div>
      </div>

      <div class="datas">
        <label class="labels">High School Graduation Year:</label>
        <div class="choicess inline">
          <select name="gradYear">
            <option value=""></option>
            <option value="2026">2026</option><option value="2027">2027</option><option value="2028">2028</option>
            <option value="2029">2029</option><option value="2030">2030</option><option value="2031">2031</option>
          </select>
        </div>
      </div>

      <div class="datas">
        <label class="labels">Grade Average:</label>
        <div class="choicess inline">
          <select name="gradeAvg">
            <option value=""></option>
            <option value="A+">A+</option><option value="A">A</option><option value="A-">A-</option>
            <option value="B+">B+</option><option value="B">B</option><option value="B-">B-</option>
            <option value="C+">C+</option><option value="C">C</option><option value="C-">C-</option>
            <option value="LC">Lower than C</option>
          </select>
        </div>
      </div>

      <div class="datas">
        <label class="labels">Gender:</label>
        <div class="choicess inline">
          <select name="gender">
            <option value=""></option>
            <option value="M">M (Male)</option>
            <option value="F">F (Female)</option>
            <option value="A">A (Another)</option>
          </select>
        </div>
      </div>

      <label class="labels"
        >Teacher Last Name:
        <input type="text" name="teacherLastName" />
      </label>

      <label class="labels"
        >Parent/Guardian Email:
        <input type="email" name="parentEmail" />
      </label>

      <!-- (Your Q1...Q17 blocks remain same as you posted) -->
      <!-- IMPORTANT: I’m not repeating them here to keep this message readable -->
      <!-- Keep all your existing Q1 to Q17 exactly the same -->

      <!-- Q18 (FIXED NAME) -->
      <label class="labels"
        >Q18:
        <input type="text" name="q18" />
      </label>

      <!-- Q19 -->
      <div class="datas">
        <label class="labels">Q19:</label>
        <div class="choices inline">
          <select name="q19">
            <option value=""></option>
            <option value="Y">Yes</option>
            <option value="N">No</option>
          </select>
        </div>
      </div>

      <div class="submit-row">
        <button id="submitBtn" type="submit" class="btn">Submit</button>
        <button id="cancelEditBtn" type="button" class="btn ghost" hidden>
          Cancel Edit
        </button>
      </div>
    </form>

    <section class="entries card">
      <h3>Submitted Entries</h3>
      <div id="entriesList" class="entries-list" aria-live="polite"></div>
    </section>

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <script>
      // --- State ---
      const form = document.getElementById("actflForm");
      const entriesList = document.getElementById("entriesList");
      const submitBtn = document.getElementById("submitBtn");
      const cancelEditBtn = document.getElementById("cancelEditBtn");
      const downloadBtn = document.getElementById("downloadBtn");

      let entries = [];
      let editIndex = null;

      // ==========================
      // IST TIME + START/END TIMER
      // ==========================
      let currentStartTimeIST = ""; // set when user starts typing

      function nowISTString() {
        // Example: 2026-01-28 09:45:12 IST
        const d = new Date();
        const parts = new Intl.DateTimeFormat("en-GB", {
          timeZone: "Asia/Kolkata",
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
          hour12: false
        }).formatToParts(d);

        const get = (t) => parts.find(p => p.type === t)?.value || "";
        const yyyy = get("year");
        const mm = get("month");
        const dd = get("day");
        const hh = get("hour");
        const mi = get("minute");
        const ss = get("second");
        return `${yyyy}-${mm}-${dd} ${hh}:${mi}:${ss} IST`;
      }

      function armStartTimeOnce() {
        if (!currentStartTimeIST) currentStartTimeIST = nowISTString();
      }

      // when user starts typing/changing any field -> StartTime
      form.addEventListener("input", (e) => {
        if (e.target && e.target.name && e.target.type !== "hidden") {
          armStartTimeOnce();
          formDirty = true;
        }
      });
      form.addEventListener("change", (e) => {
        if (e.target && e.target.name && e.target.type !== "hidden") {
          armStartTimeOnce();
        }
      });

      // --- DOB dropdown logic (Month -> Day, with leap-year via Year) ---
      (function () {
        const monthSel = document.getElementById("birthMonth");
        const daySel = document.getElementById("birthDay");
        const yearInp = document.getElementById("birthYear");

        function pad2(n) { return String(n).padStart(2, "0"); }
        function daysInMonth(m, y) {
          const yr = /^\d{4}$/.test(y) ? +y : 2001;
          return new Date(yr, m, 0).getDate();
        }
        function refreshDays() {
          if (!daySel) return;
          daySel.innerHTML = '<option value="">DD</option>';
          const m = parseInt(monthSel.value, 10);
          if (!m) { daySel.disabled = true; return; }
          const count = daysInMonth(m, yearInp.value);
          for (let d = 1; d <= count; d++) {
            const v = pad2(d);
            const opt = document.createElement("option");
            opt.value = v; opt.textContent = v;
            daySel.appendChild(opt);
          }
          daySel.disabled = false;
        }

        if (monthSel && daySel && yearInp) {
          monthSel.addEventListener("change", refreshDays);
          yearInp.addEventListener("change", () => { if (monthSel.value === "02") refreshDays(); });
          document.addEventListener("DOMContentLoaded", () => { if (monthSel.value) refreshDays(); });
        }
      })();

      // ====== Q15 validation: only 01–72 in three text boxes ======
      const Q15_REGEX = /^(0[1-9]|[1-6][0-9]|7[0-2])$/;

      function attachQ15Validation() {
        const inputs = document.querySelectorAll("#q15 .q15in");
        inputs.forEach((inp) => {
          inp.addEventListener("input", (e) => {
            e.target.value = e.target.value.replace(/\D/g, "").slice(0, 2);
            const v = e.target.value;
            if (!v) { e.target.setCustomValidity(""); return; }
            e.target.setCustomValidity(Q15_REGEX.test(v) ? "" : "Enter 01–72");
          });
          inp.addEventListener("blur", (e) => {
            const v = e.target.value;
            if (/^[1-9]$/.test(v)) e.target.value = "0" + v;
            const ok = !e.target.value || Q15_REGEX.test(e.target.value);
            e.target.setCustomValidity(ok ? "" : "Enter 01–72");
          });
        });
      }

      // --- Unsaved data guard ---
      let formDirty = false;
      window.addEventListener("beforeunload", (e) => {
        if (entries.length > 0 || formDirty) {
          e.preventDefault();
          e.returnValue = "";
          return "";
        }
      });

      // --- Serialize Form ---
      function serializeForm(f) {
        const data = {};
        const elements = Array.from(f.elements).filter((el) => el.name);

        data["SurveyYear"] = "2026";
        data["SurveyType"] = "SP";

        // Add StartTime (if not yet set but user clicks submit directly)
        if (!currentStartTimeIST) currentStartTimeIST = nowISTString();
        data["StartTime"] = currentStartTimeIST;

        elements.forEach((el) => {
          if (el.type === "checkbox") {
            if (!data[el.name]) data[el.name] = [];
            if (el.checked) data[el.name].push(el.value);
          } else if (el.tagName === "SELECT" || ["text", "email", "number"].includes(el.type)) {
            data[el.name] = el.value.trim();
          }
        });

        // Add EndTime at submit moment
        data["EndTime"] = nowISTString();

        return data;
      }

      // --- Fill Form with Data (Edit mode) ---
      function fillForm(data) {
        form.reset();
        for (const [name, value] of Object.entries(data)) {
          const controls = form.querySelectorAll(`[name="${CSS.escape(name)}"]`);
          if (!controls.length) continue;
          const isArray = Array.isArray(value);

          controls.forEach((ctrl) => {
            if (ctrl.type === "checkbox") {
              ctrl.checked = isArray ? value.includes(ctrl.value) : value === ctrl.value;
            } else if (ctrl.tagName === "SELECT" || ["text", "email", "number", "hidden"].includes(ctrl.type)) {
              ctrl.value = isArray ? value.join(", ") : value;
            }
          });
        }

        // Keep existing StartTime for edits
        currentStartTimeIST = data.StartTime || "";

        submitBtn.textContent = "Update";
        cancelEditBtn.hidden = false;
        window.scrollTo({ top: 0, behavior: "smooth" });
        formDirty = false;
      }

      function resetForm() {
        form.reset();
        editIndex = null;
        submitBtn.textContent = "Submit";
        cancelEditBtn.hidden = true;
        formDirty = false;
        currentStartTimeIST = ""; // new entry should start a new timer
      }

      // ====== Render entries list ======
      function renderEntries() {
        entriesList.innerHTML = "";
        if (!entries.length) {
          entriesList.innerHTML = '<p class="muted">No entries yet. Fill the form and click Submit.</p>';
          return;
        }

        entries.forEach((entry, idx) => {
          const card = document.createElement("details");
          card.className = "entry";
          if (idx === entries.length - 1) card.open = true;

          const title = document.createElement("summary");
          const first = entry.firstName || "";
          const last = entry.lastName || "";
          title.textContent = `Entry #${idx + 1} — ${first} ${last}`.trim();
          card.appendChild(title);

          const grid = document.createElement("div");
          grid.className = "kv";

          const keys = Object.keys(entry).sort((a, b) => a.localeCompare(b));
          for (const key of keys) {
            const k = document.createElement("div"); k.className = "k"; k.textContent = key;
            const v = document.createElement("div"); v.className = "v";
            const val = Array.isArray(entry[key]) ? entry[key].join(", ") : entry[key];
            v.textContent = val ?? "";
            grid.appendChild(k); grid.appendChild(v);
          }

          const actions = document.createElement("div");
          actions.className = "row-actions";

          const editBtn = document.createElement("button");
          editBtn.type = "button"; editBtn.className = "btn sm"; editBtn.textContent = "Edit";
          editBtn.onclick = () => { editIndex = idx; fillForm(entries[idx]); };

          const delBtn = document.createElement("button");
          delBtn.type = "button"; delBtn.className = "btn sm danger"; delBtn.textContent = "Delete";
          delBtn.onclick = () => { entries.splice(idx, 1); renderEntries(); resetForm(); };

          actions.appendChild(editBtn); actions.appendChild(delBtn);
          card.appendChild(grid); card.appendChild(actions);
          entriesList.appendChild(card);
        });
      }

      // --- Export Entries to Excel (StartTime/EndTime after q19) ---
      function toExcel() {
        if (!entries.length) {
          alert("No entries to download.");
          return;
        }

        // Flatten arrays to strings for Excel
        const flat = entries.map((obj) => {
          const out = {};
          for (const [k, v] of Object.entries(obj)) {
            out[k] = Array.isArray(v) ? v.join(", ") : v;
          }
          return out;
        });

        // Build a preferred column order, then append anything missing
        const preferred = [
          "SurveyYear","SurveyType",
          "evid","form","firstName","lastName","homeAddress","city","state","zipCode","zipCode4",
          "personalEmail","birthMonth","birthDay","birthYear",
          "gradYear","gradeAvg","gender","teacherLastName","parentEmail",
          // your Q fields (keep as they exist in your form)
          "q1-a","q1-b","q2","q3","q4","q5","q6","q7","q8","q9","q10",
          "q11_1a","q11_2a","q11_3a",
          "college1","state1","college1YN","college2","state2","college2YN","college3","state3","college3YN",
          "college4","state4","college4YN","college5","state5","college5YN",
          "q13_1","q13_2","q13_3",
          "q14","q15","q16-a","q16-b","q17",
          "q18","q19",
          // REQUIRED: after q19
          "StartTime","EndTime"
        ];

        const allKeys = Array.from(new Set(flat.flatMap(o => Object.keys(o))));
        const cols = [
          ...preferred.filter(c => allKeys.includes(c)),
          ...allKeys.filter(c => !preferred.includes(c))
        ];

        const normalized = flat.map((o) => {
          const r = {};
          cols.forEach((c) => (r[c] = o[c] ?? ""));
          return r;
        });

        const ws = XLSX.utils.json_to_sheet(normalized, { header: cols });
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "N-FCCLA Entries");

        const pad = (n) => String(n).padStart(2, "0");
        const d = new Date();
        const fname = `N-FCCLA_Submissions_${d.getFullYear()}${pad(d.getMonth() + 1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}.xlsx`;
        XLSX.writeFile(wb, fname);
      }

      // --- Events ---
      form.addEventListener("submit", (e) => {
        e.preventDefault();
        const data = serializeForm(form);

        if (editIndex !== null) {
          entries[editIndex] = data;
        } else {
          entries.push(data);
        }
        renderEntries();
        resetForm();
      });

      cancelEditBtn.addEventListener("click", resetForm);
      downloadBtn.addEventListener("click", toExcel);

      // init
      attachQ15Validation();
      renderEntries();
    </script>
  </body>
</html>
